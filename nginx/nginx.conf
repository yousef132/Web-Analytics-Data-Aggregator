# The events block sets global Nginx settings like max simultaneous connections
events {
    worker_connections 1024;  # Maximum number of simultaneous connections per worker process
}

http {
    # Define an upstream group (a pool of backend servers to load balance)
    upstream backend_cluster {
        # This server name should match the service name in Docker Compose
        # Docker DNS will resolve it and provide all replicas automatically (round-robin)
        server backend:8080;  
    }

    # Define the nginx server block to listen for incoming HTTP requests
    server {
        listen 80;  # Port where Nginx will accept HTTP requests

        # Define a location block for all requests
        location / {
            # Pass requests to the upstream backend_cluster
            proxy_pass http://backend_cluster;

            # Proxy settings to forward headers correctly to the backend
            proxy_http_version 1.1;                  # Use HTTP/1.1 for proxying
            proxy_set_header Host $host;             # Forward original Host header
            proxy_set_header X-Real-IP $remote_addr; # Forward client IP, let the backend see also the client ip from headers
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Forward all IPs in chain
            proxy_set_header X-Forwarded-Proto $scheme; # Forward protocol (http or https)

            # Timeout settings
            proxy_connect_timeout 5s;  # Max time to wait for a connection to the backend
            proxy_send_timeout 30s;    # Max time to wait to send data to the backend
            proxy_read_timeout 30s;    # Max time to wait to read response from the backend
        }
    }
}
